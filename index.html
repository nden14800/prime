<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>素因数分解：数の原子と暗号の鍵 - 究極のアーカイブ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', // デバイスのテーマ設定に自動追従
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Noto Serif JP"', 'serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            scroll-behavior: smooth;
            line-height: 2.4; /* 行間を広げて読みやすく */
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .serif-text {
            font-family: 'Noto Serif JP', serif;
        }

        /* Slide-out Panel Styles */
        .quiz-panel {
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            transform: translateX(100%);
            box-shadow: -10px 0 25px -5px rgba(0, 0, 0, 0.1);
        }

        .quiz-panel.active {
            transform: translateX(0);
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }
        
        @media (prefers-color-scheme: dark) {
            .glass-morphism {
                background: rgba(15, 23, 42, 0.85);
                border-bottom: 1px solid rgba(51, 65, 85, 0.6);
            }
        }

        .content-card {
            width: 100%;
            border-radius: 1.5rem;
            padding: 4rem;
            margin-bottom: 5rem;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.08);
        }

        .equation-box {
            border-left: 6px solid #4f46e5;
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.05) 0%, transparent 100%);
            padding: 3rem;
            margin: 4rem 0;
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            border-radius: 0 1rem 1rem 0;
            font-family: 'Noto Serif JP', serif;
            letter-spacing: 0.05em;
        }

        .chapter-title {
            position: relative;
            padding-bottom: 1.5rem;
            margin-bottom: 3.5rem;
            font-size: 2.25rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            line-height: 1.3;
            border-bottom: 1px solid #cbd5e1;
        }
        
        @media (prefers-color-scheme: dark) {
            .chapter-title {
                border-bottom: 1px solid #334155;
            }
        }

        .chapter-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 80px;
            height: 4px;
            background: #4f46e5;
            border-radius: 2px;
        }

        .sub-section-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-top: 4.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            color: #312e81;
        }
        
        @media (prefers-color-scheme: dark) {
            .sub-section-title {
                color: #e0e7ff;
            }
        }

        .sub-section-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 28px;
            background: #6366f1;
            margin-right: 16px;
            border-radius: 99px;
        }

        p { margin-bottom: 2.5rem; font-size: 1.125rem; text-align: justify; letter-spacing: 0.04em; color: #334155; }
        
        @media (prefers-color-scheme: dark) {
            p { color: #94a3b8; }
        }

        .diagram-box {
            border-radius: 2rem;
            padding: 4rem;
            margin: 5rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }
        
        @media (prefers-color-scheme: dark) {
            .diagram-box {
                background-color: #0f172a;
                border: 1px solid #1e293b;
            }
        }

        .highlight-text {
            background: linear-gradient(180deg, transparent 65%, #c7d2fe 65%);
            font-weight: 700;
            padding: 0 4px;
            color: #1e1b4b;
        }
        
        @media (prefers-color-scheme: dark) {
            .highlight-text {
                background: linear-gradient(180deg, transparent 65%, #312e81 65%);
                color: #e0e7ff;
            }
        }

        /* Trivia Box Styling */
        .trivia-box {
            border-radius: 1.25rem;
            padding: 2.5rem 3rem;
            margin: 4rem 0;
            position: relative;
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
        }
        
        @media (prefers-color-scheme: dark) {
            .trivia-box {
                background-color: rgba(120, 53, 15, 0.1);
                border: 1px solid rgba(180, 83, 9, 0.4);
            }
        }

        .trivia-badge {
            position: absolute;
            top: -16px;
            left: 32px;
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
            padding: 6px 20px;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Quiz UI */
        .quiz-input {
            transition: all 0.2s ease;
        }
        .quiz-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        .correct-answer {
            background-color: #f0fdf4 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
            box-shadow: 0 0 0 1px #22c55e;
        }
        .incorrect-answer {
            background-color: #fef2f2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            box-shadow: 0 0 0 1px #ef4444;
        }
        
        .feedback-box {
            display: none;
            margin-top: 1.5rem;
            padding: 2rem;
            border-radius: 1rem;
            font-size: 1rem;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* KaTeX SVG fix */
        foreignObject { overflow: visible; }
        
        .hero-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #0ea5e9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    
        @media (max-width: 768px) {
            .content-card { padding: 2rem 1.5rem !important; margin-bottom: 3rem !important; }
            .equation-box { font-size: 1.5rem !important; padding: 1.5rem !important; margin: 2rem 0 !important; }
            .chapter-title { font-size: 1.75rem !important; margin-bottom: 2rem !important; }
            .sub-section-title { font-size: 1.3rem !important; margin-top: 3rem !important; }
            p { font-size: 1rem !important; line-height: 1.8 !important; margin-bottom: 1.5rem !important; }
            .diagram-box { padding: 2rem 1rem !important; margin: 3rem 0 !important; }
            .trivia-box { padding: 2rem 1.5rem !important; margin: 3rem 0 !important; }
            .quiz-panel { width: 100% !important; }
            .max-w-4xl { padding-left: 1rem !important; padding-right: 1rem !important; }
            .max-w-7xl { padding-left: 1rem !important; padding-right: 1rem !important; }
        }
    
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 selection:bg-indigo-200 dark:selection:bg-indigo-900">

    <!-- Navigation -->
    <nav class="sticky top-0 z-40 glass-morphism">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Simple Factorization Symbol Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600 dark:text-indigo-400" viewBox="0 0 24 24">
                     <circle cx="12" cy="5" r="3" />
                     <path d="M12 8v4" />
                     <path d="M12 12l-4 4" />
                     <path d="M12 12l4 4" />
                     <circle cx="8" cy="19" r="3" />
                     <circle cx="16" cy="19" r="3" />
                </svg>
                <span class="font-bold text-lg tracking-tight hidden sm:block">Archive: Prime</span>
            </div>
            <button id="quizTrigger" class="group bg-slate-900 text-white dark:bg-indigo-600 dark:text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center gap-3 text-sm md:text-base border border-transparent hover:border-indigo-400">
                <!-- Bootstrap Icon: pencil-square -->
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="transition-transform group-hover:rotate-12" viewBox="0 0 16 16">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                <span>無限演習ジェネレーター</span>
            </button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto w-full overflow-x-hidden px-6 py-24">
        
        <!-- Hero Section -->
        <header class="text-center mb-32">
            <div class="inline-block px-4 py-1.5 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:border-indigo-800 dark:text-indigo-300 text-xs font-bold uppercase tracking-widest mb-6">
                The Atomic Number
            </div>
            <h1 class="text-5xl md:text-8xl font-black mb-10 tracking-tight leading-tight">
                <span class="hero-gradient">素因数分解</span>
            </h1>
            <p class="text-xl md:text-2xl text-slate-600 dark:text-slate-400 serif-text max-w-3xl mx-auto leading-loose">
                複雑な数を「素数」という原子へと還元する解析のメス。<br>
                合成数の内部に潜む固有の構造と秩序。<br>
                その一意性、歴史的探求、そして現代の暗号技術を支える不可視の力を徹底的に紐解く。
            </p>
        </header>

        <!-- Chapter 1: Essence -->
        <section class="content-card bg-white border border-slate-100 dark:bg-slate-900 dark:border-slate-800">
            <h2 class="chapter-title text-slate-900 dark:text-slate-100">第1章：数の原子と「素数」の概念</h2>
            <div class="serif-text">
                <p>
                    <strong>素因数分解（Prime Factorization）</strong>とは、正の整数を「これ以上分解できない数」の積の形に書き表すことである。化学の世界で全ての物質が原子の組み合わせでできているように、数学の世界ではすべての自然数は「素数」という原子の組み合わせで構成されている。$12$ を $2^2 \times 3$ と表すことは、その数の設計図（DNA）を解読する行為に他ならない。
                </p>

                <p>
                    なぜ素数が重要なのか？ それは、素数が乗算における「究極の構成要素」だからだ。$2, 3, 5, 7, 11...$ と続く素数は、他の数で割り切れることのない孤独で純粋な数である。一方、これらを掛け合わせてできる数を「合成数」と呼ぶ。素因数分解は、合成数という<span class="highlight-text">「化合物を原子レベルまで分解」</span>する操作である。
                </p>

                <div class="diagram-box">
                    <h4 class="text-lg font-bold mb-12 text-slate-700 dark:text-slate-300 tracking-wider">数の構造ツリー</h4>
                    
                    <!-- HTML/CSS based diagram for perfect KaTeX integration -->
                    <div class="relative flex flex-col items-center justify-center p-8">
                        
                        <!-- Tree Diagram Structure -->
                        <div class="relative flex flex-col items-center gap-8">
                            
                            <!-- Top Node (Composite Number) -->
                            <div class="w-32 h-32 bg-indigo-50 dark:bg-indigo-900/20 border-2 border-indigo-500 dark:border-indigo-400 rounded-full flex flex-col items-center justify-center shadow-lg relative z-10">
                                <div class="text-4xl text-indigo-900 dark:text-indigo-100 font-bold">
                                    $$ 60 $$
                                </div>
                            </div>

                            <!-- Lines -->
                            <div class="relative w-64 h-16">
                                <svg class="absolute top-0 left-0 w-full h-full text-slate-300 dark:text-slate-600" viewBox="0 0 200 50" preserveAspectRatio="none">
                                    <line x1="100" y1="0" x2="30" y2="50" stroke="currentColor" stroke-width="2" />
                                    <line x1="100" y1="0" x2="170" y2="50" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </div>

                            <!-- Second Level -->
                            <div class="flex gap-24">
                                <!-- Factor 6 -->
                                <div class="flex flex-col items-center">
                                    <div class="w-20 h-20 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-full flex items-center justify-center mb-4">
                                        <div class="text-2xl font-bold">$$ 6 $$</div>
                                    </div>
                                    <!-- Branches -->
                                    <div class="flex gap-4">
                                        <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-400 rounded-full flex items-center justify-center text-rose-800 dark:text-rose-200 font-bold shadow-sm transform translate-y-2">$$2$$</div>
                                        <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-400 rounded-full flex items-center justify-center text-rose-800 dark:text-rose-200 font-bold shadow-sm transform translate-y-2">$$3$$</div>
                                    </div>
                                </div>

                                <!-- Factor 10 -->
                                <div class="flex flex-col items-center">
                                    <div class="w-20 h-20 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-full flex items-center justify-center mb-4">
                                        <div class="text-2xl font-bold">$$ 10 $$</div>
                                    </div>
                                    <!-- Branches -->
                                    <div class="flex gap-4">
                                        <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-400 rounded-full flex items-center justify-center text-rose-800 dark:text-rose-200 font-bold shadow-sm transform translate-y-2">$$2$$</div>
                                        <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-400 rounded-full flex items-center justify-center text-rose-800 dark:text-rose-200 font-bold shadow-sm transform translate-y-2">$$5$$</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-12 italic text-center max-w-lg">
                        60という数は、分解していくと最終的に<br>$2, 2, 3, 5$ という素数（赤丸）に行き着く。<br>これ以上は絶対に分解できない原子の状態である。
                    </p>
                </div>

                <div class="equation-box text-slate-900 dark:text-slate-100 shadow-sm">
                    $$ n = p_1^{a_1} p_2^{a_2} \cdots p_k^{a_k} $$
                </div>

                <h3 class="sub-section-title">物理的な解釈：構成要素の抽出</h3>
                <p>
                    加法（足し算）における構成要素が「1」であるのに対し、乗法（掛け算）における構成要素は「素数」である。
                    整数論の世界では、数は単なる量ではなく、どのような素数成分を含んでいるかという「質」が重要視される。
                    例えば $60$ と $42$ の最大公約数を求めるとき、我々はそれぞれの数を素因数分解し、共通の素数成分（$2$ と $3$）を抽出している。これは物質の中から特定の元素を分析する分光分析にも似ている。
                </p>
                <p>
                    また、1は素数に含まれない。もし1を素数と認めてしまうと、「素因数分解の一意性（ただ一通りに決まること）」が崩れてしまうからだ。例えば $6 = 2 \times 3$ だが、1を許すと $6 = 1 \times 2 \times 3$ や $6 = 1^5 \times 2 \times 3$ など、無限通りの表し方ができてしまい、定理としての美しさと有用性が失われてしまう。
                </p>

                <!-- Trivia 1 -->
                <div class="trivia-box">
                    <span class="trivia-badge">
                        豆知識：なぜ「素（Prime）」なのか？
                    </span>
                    <p class="mb-0 text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                        「素数」の英語「Prime Number」の Prime は、ラテン語の「Primus（最初の、第一の）」に由来する。
                        これは、素数が全ての数の「根源」であり、他のすべての数（合成数）を生み出す「第一の存在」であると考えられていたからだ。
                        日本語の「素」も、「素材」「元素」のように「もとになるもの」という意味を持っている。
                    </p>
                </div>
            </div>
        </section>

        <!-- Chapter 1.5: Calculation (Expanded) -->
        <section class="content-card bg-white border border-slate-100 dark:bg-slate-900 dark:border-slate-800">
            <h2 class="chapter-title text-slate-900 dark:text-slate-100">実践：素因数分解のアルゴリズム</h2>
            <div class="serif-text">
                <h3 class="sub-section-title">分解の手法：2つのアプローチ</h3>
                <p>
                    素因数分解を行うための定石は大きく分けて2つある。数の大きさや特徴に応じて使い分けることが重要だ。
                </p>

                <!-- Method 1 -->
                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-8 rounded-2xl border border-indigo-100 dark:border-indigo-800 mb-10">
                    <p class="font-bold text-indigo-900 dark:text-indigo-200 mb-4 flex items-center gap-2">
                        <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">1</span>
                        手法1：筆算による分解（すだれ算）
                    </p>
                    <div class="pl-4 border-l-2 border-indigo-200 dark:border-indigo-700">
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-6">
                            最も基本的かつ強力な方法は、割り切れる素数で次々と割っていく方法である。スローガンは<strong>「小さい素数から順に試す」</strong>だ。
                        </p>
                        
                        <div class="flex flex-col md:flex-row gap-8 items-center">
                            <div class="text-lg font-serif bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                                <p class="text-xs text-slate-400 mb-2 font-sans font-bold uppercase tracking-widest text-center">Example: 72</p>
                                $$
                                \begin{array}{r|l}
                                2 & \underline{72} \\
                                2 & \underline{36} \\
                                2 & \underline{18} \\
                                3 & \underline{\phantom{0}9} \\
                                  & \phantom{0}3
                                \end{array}
                                $$
                            </div>
                            <div class="flex-1">
                                <ol class="list-decimal list-inside space-y-2 text-slate-700 dark:text-slate-300 text-sm">
                                    <li>偶数なので $2$ で割る $\rightarrow 36$</li>
                                    <li>まだ偶数なので $2$ で割る $\rightarrow 18$</li>
                                    <li>まだ偶数なので $2$ で割る $\rightarrow 9$</li>
                                    <li>奇数になった。次は $3$ で割る $\rightarrow 3$</li>
                                    <li>最後が素数($3$)になったら終了。</li>
                                </ol>
                                <div class="text-xl font-bold text-indigo-800 dark:text-indigo-300 mt-4 p-3 bg-white dark:bg-slate-800 rounded-lg border border-indigo-100 dark:border-indigo-900 text-center">
                                    $$ 72 = 2^3 \times 3^2 $$
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Method 2 -->
                <div class="bg-rose-50 dark:bg-rose-900/20 p-8 rounded-2xl border border-rose-100 dark:border-rose-800 mb-8">
                    <p class="font-bold text-rose-900 dark:text-rose-200 mb-4 flex items-center gap-2">
                        <span class="bg-rose-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">2</span>
                        手法2：樹形図アプローチ（枝分かれ法）
                    </p>
                    <div class="pl-4 border-l-2 border-rose-200 dark:border-rose-700">
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-6">
                            いきなり小さい素数で割るのが難しい大きな数の場合、とりあえず思いつく掛け算のペアに分解し、そこから細かく砕いていく方法も有効である。
                        </p>
                        
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-rose-100 dark:border-rose-900 shadow-sm">
                            <p class="font-bold mb-4 text-rose-800 dark:text-rose-300 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>
                                例：$1200$ の分解
                            </p>
                            <ol class="list-decimal list-inside space-y-3 text-slate-700 dark:text-slate-300 text-sm ml-2 mb-4">
                                <li>$1200$ を $12 \times 100$ に分ける。</li>
                                <li>$12$ を $3 \times 4$、さらに $3 \times 2 \times 2$ へ。</li>
                                <li>$100$ を $10 \times 10$、さらに $(2 \times 5) \times (2 \times 5)$ へ。</li>
                                <li>全ての「枝先」にある素数を集める。$2$が4個、$3$が1個、$5$が2個。</li>
                            </ol>
                            <div class="pt-4 border-t border-rose-100 dark:border-rose-800 text-center text-xl font-bold text-rose-800 dark:text-rose-300">
                                $$ 1200 = 2^4 \times 3 \times 5^2 $$
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trivia 2 -->
                <div class="trivia-box">
                    <span class="trivia-badge">
                        豆知識：素数砂漠と双子素数
                    </span>
                    <p class="mb-0 text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                        素数の分布は非常に不規則である。$100!+2$ から $100!+100$ までの間には99個連続して素数が現れる区間（素数砂漠）を作ることができる。
                        一方で、$(3,5)$ や $(11,13)$ のように差が2しかない「双子素数」は、数が大きくなっても無限に現れると予想されているが、未だ証明されていない（双子素数予想）。
                    </p>
                </div>
            </div>
        </section>

        <!-- Chapter 2: History -->
        <section class="content-card bg-white border border-slate-100 dark:bg-slate-900 dark:border-slate-800">
            <h2 class="chapter-title text-slate-900 dark:text-slate-100">第2章：エラトステネスの篩とユークリッド</h2>
            <div class="serif-text text-xl leading-relaxed">
                <p>
                    素数の歴史は、人類が「数の無限性」に挑んできた歴史でもある。古代ギリシャの数学者たちは、計算機のない時代に驚くべき洞察力で素数の性質を解き明かしていた。
                </p>
                
                <h3 class="sub-section-title">エラトステネスの篩（ふるい）</h3>
                <p>
                    紀元前3世紀、エラトステネスは素数を効率的に見つけるアルゴリズムを考案した。
                    まず自然数を並べる。次に「2の倍数」をすべて消す。次に残った数の中で最小の「3」の倍数をすべて消す。これを繰り返すと、あたかも網の目で砂をふるい落とすように、合成数だけが消え去り、素数だけが残る。
                    この単純ながら美しい手法は、2000年以上経った現代のコンピュータ・アルゴリズムの基礎ともなっている。
                </p>

                <h3 class="sub-section-title">『原論』と無限の証明</h3>
                <p>
                    ユークリッドは著書『原論』の中で、「素数が無限に存在すること」を証明した。
                    もし素数が有限個しかないと仮定し、それらをすべて掛け合わせて1を足した数 $N$ を作る。$N$ はどの既知の素数で割っても1余るため、割り切れない。
                    したがって、$N$ 自体が新しい素数であるか、あるいは未知の素数を因数に持つことになる。これは「素数が有限である」という仮定と矛盾する。
                    この背理法による証明は、数学史上最もエレガントな証明の一つと称えられている。
                </p>

                <!-- Trivia 3 -->
                <div class="trivia-box">
                    <span class="trivia-badge">
                        豆知識：人類最大の素数（2026年現在）
                    </span>
                    <p class="mb-0 text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                        2024年10月、GIMPSプロジェクトによって人類史上最大の素数 $2^{136,279,841}-1$ が発見された。この数は41,024,320桁という途方もない長さであり、書き下すだけで電話帳数千冊分になる。発見者はLuke Durant氏で、GPUを用いたクラウドコンピューティングにより発見された。（2026年2月時点の情報）
                    </p>
                </div>
            </div>
        </section>

        <!-- Chapter 3: Proofs -->
        <section class="content-card bg-white border border-slate-100 dark:bg-slate-900 dark:border-slate-800">
            <h2 class="chapter-title text-slate-900 dark:text-slate-100">第3章：算術の基本定理</h2>
            <div class="serif-text text-xl leading-relaxed">
                <p>
                    「全ての自然数は、素数の積としてただ一通りに表される」。これは<strong>算術の基本定理（Fundamental Theorem of Arithmetic）</strong>と呼ばれ、初等整数論における最も重要な定理である。
                </p>

                <h3 class="sub-section-title">一意性の証明の重要性</h3>
                <p>
                    なぜ「ただ一通り（Uniqueness）」が重要なのか？ もし分解の仕方が複数あったとしたら、数学の秩序は崩壊する。
                    例えば、$12$ が $2 \times 2 \times 3$ でもあり、同時に $5 \times 7$ でもあるとしたら、約数や倍数の概念、分数の約分などがすべて定義不能になってしまう。
                </p>
                
                <h3 class="sub-section-title">証明のスケッチ</h3>
                <p>
                    この定理の証明には「ユークリッドの補題」が鍵となる。「素数 $p$ が積 $ab$ を割り切るなら、$p$ は $a$ か $b$ の少なくとも一方を割り切る」という性質だ。
                    これを利用して、もし2通りの素因数分解が存在すると仮定しても、両辺の素数を一つずつ消去していくと、結局は同じ素数の組み合わせしか残らないことが示される。
                    この定理こそが、素数を「数の原子」と呼ぶ数学的な根拠なのである。
                </p>

                <!-- Trivia 4 -->
                <div class="trivia-box">
                    <span class="trivia-badge">
                        豆知識：素数ゼミ
                    </span>
                    <p class="mb-0 text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                        北米には13年または17年ごとに大量発生する「素数ゼミ」が生息している。
                        なぜ素数の周期なのか？ それは捕食者の発生周期（例えば2年や3年）と重なることを避けるためだと考えられている。
                        13と17は素数なので、最小公倍数が大きくなり、天敵と遭遇する確率が極限まで低くなる。自然淘汰が生んだ数学的生存戦略だ。
                    </p>
                </div>
            </div>
        </section>

        <!-- Chapter 4: Modern World -->
        <section class="content-card bg-white border border-slate-100 dark:bg-slate-900 dark:border-slate-800">
            <h2 class="chapter-title text-slate-900 dark:text-slate-100">第4章：現代セキュリティの守護神</h2>
            <div class="serif-text text-xl leading-relaxed">
                <p>
                    素因数分解は、黒板の上の遊戯ではない。インターネットバンキング、機密情報の通信、軍事通信など、現代社会の安全を守る「鍵」として機能している。
                </p>

                <h3 class="sub-section-title">RSA暗号の仕組み</h3>
                <p>
                    公開鍵暗号方式の一つであるRSA暗号は、「掛け算は一瞬でできるが、素因数分解は極めて困難である」という非対称性を利用している。
                    例えば、2つの巨大な素数 $p$ と $q$ を選んで $N = p \times q$ を計算するのはコンピュータなら一瞬だ。しかし、逆にその積 $N$ だけを与えられて、「元の $p$ と $q$ を求めよ」と言われても、$N$ が数百桁であればスーパーコンピュータでも宇宙の寿命ほどの時間がかかる。
                </p>

                <h3 class="sub-section-title">桁数が保証する安全</h3>
                <p>
                    この「分解の困難さ」こそがセキュリティの根幹である。私たちがクレジットカード番号をネットで送信できるのは、そのデータが巨大な合成数 $N$ によって守られているからだ。
                    もし誰かが効率的に素因数分解を行う画期的なアルゴリズムを発見したり、量子コンピュータが実用化されたりすれば、現在の暗号システムは崩壊の危機に瀕するだろう。素数は現代文明のデジタル要塞を守る門番なのである。
                </p>
                
                <!-- Trivia 5 -->
                <div class="trivia-box">
                    <span class="trivia-badge">
                        豆知識：リーマン予想
                    </span>
                    <p class="mb-0 text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                        素数の分布規則に関する数学界最大の未解決問題、それが「リーマン予想」である。
                        「ゼータ関数の非自明なゼロ点はすべて一直線上にある」というこの予想が証明されれば、素数の分布について完全な理解が得られることになる。
                        その影響力は計り知れず、暗号技術の安全性にも関わるため、100万ドルの懸賞金がかけられている。
                    </p>
                </div>
            </div>
        </section>

        <!-- Summary -->
        <section class="text-center py-24 bg-white rounded-3xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            <div class="h-1 bg-indigo-100 dark:bg-indigo-900/30 w-32 mx-auto mb-12 rounded-full"></div>
            <h2 class="text-4xl font-black mb-10 text-slate-800 dark:text-slate-100 tracking-tight">混沌の中の秩序</h2>
            <p class="text-xl text-slate-500 dark:text-slate-400 max-w-3xl mx-auto serif-text leading-loose px-4">
                素因数分解を行うとき、<br>
                私たちは数の内側に秘められたDNAを読み解いている。<br>
                一見不規則に現れる素数たちの背後には、<br>
                宇宙の真理にも似た厳格な秩序が存在し、<br>
                それが現代のデジタル社会を静かに支え続けている。<br>
                素数は、神が人間に与えた最も純粋で、最も難解なパズルなのである。
            </p>
        </section>

    </main>

    <!-- Quiz Panel -->
    <div id="quizPanel" class="quiz-panel w-full md:w-[450px] fixed top-0 right-0 h-full w-full md:w-[650px] bg-white shadow-2xl z-50 flex flex-col border-l border-slate-100 dark:bg-slate-900 dark:border-slate-800">
        <!-- Panel Header -->
        <div class="p-8 border-b flex justify-between items-center bg-indigo-900 text-white shadow-md dark:bg-slate-950 dark:border-slate-800">
            <div>
                <h3 class="text-2xl font-bold flex items-center gap-3">
                    Practice Problems
                </h3>
                <p class="text-xs text-indigo-200 mt-1 uppercase tracking-widest pl-0">Infinite Random Generator</p>
            </div>
            <div class="flex gap-2">
                <button id="generateBtn" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-bold transition-all shadow-lg border border-indigo-400 flex items-center gap-2 dark:bg-indigo-700 dark:hover:bg-indigo-600 dark:border-indigo-600 transform active:scale-95">
                    <!-- Bootstrap Icon: shuffle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>
                        <path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>
                    </svg>
                    問題を生成
                </button>
                <button id="closeQuiz" class="p-2.5 hover:bg-indigo-800 rounded-lg transition-colors text-indigo-200 hover:text-white">
                    <!-- Bootstrap Icon: x-lg -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Quiz Content Area -->
        <div class="flex-1 overflow-y-auto p-8 bg-slate-50 dark:bg-slate-900 scrollbar-thin">
            <div id="quizContainer" class="space-y-12">
                <div class="text-center text-slate-500 dark:text-slate-400 py-32 flex flex-col items-center justify-center h-full">
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-8 rounded-full mb-8 animate-pulse">
                        <!-- Bootstrap Icon: patch-check-fill -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-indigo-400" viewBox="0 0 16 16">
                            <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89-.01-.622-.636zM10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                    </div>
                    <p class="text-2xl mb-3 font-bold text-slate-700 dark:text-slate-200">準備完了</p>
                    <p class="text-slate-500 dark:text-slate-400 max-w-xs mx-auto">右上の「問題を生成」ボタンを押して、<br>自動生成プログラムによる演習を開始してください。</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-slate-900 text-white py-24 text-center dark:bg-slate-950 dark:border-t dark:border-slate-800">
        <p class="text-slate-500 mb-6 tracking-[0.4em] text-sm uppercase">Mathematical Archive Project</p>
        <p class="text-sm opacity-40 serif-text italic max-w-md mx-auto leading-relaxed">
            "God may not play dice with the universe, but something strange is going on with the prime numbers."
            <br>– Paul Erdős
        </p>
    </footer>

    <script>
        // Global variables for the quiz
        let currentQuestions = [];
        
        // --- 1. Math Render Logic ---
        function renderMath() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false
            });
        }

        // --- 2. Problem Generation Algorithm (Prime Factorization) ---
        function generateFactorization() {
            const problems = [];
            const primes = [2, 3, 5, 7, 11, 13, 17, 19];
            
            // Generate 10 random problems
            for (let i = 0; i < 10; i++) {
                const type = Math.random();
                let questionText = "";
                let targetVal = 0;
                let explanation = "";
                let unit = "";

                if (type < 0.25) {
                    // Type 1: Find the largest prime factor
                    const p1 = primes[Math.floor(Math.random() * 4)]; // 2,3,5,7
                    const p2 = primes[Math.floor(Math.random() * 6)]; // 2..13
                    const num = p1 * p2 * (Math.random() > 0.5 ? Math.floor(Math.random() * 3) + 1 : 1);
                    // Re-calculate actual largest prime
                    let temp = num;
                    let maxP = 0;
                    for(let k=2; k<=temp; k++){
                        while(temp%k === 0){
                            maxP = k;
                            temp /= k;
                        }
                    }

                    questionText = `次の数を素因数分解したとき、最も大きな素因数は何ですか？<br>数：$${num}$`;
                    targetVal = maxP;
                    explanation = `<strong>素因数分解して確認する</strong><br>
                    $${num}$ を素因数分解すると...<br>
                    $${getFactorizationString(num)}$ となります。<br>
                    この中で最も大きい素数は $${maxP}$ です。`;

                } else if (type < 0.5) {
                    // Type 2: Count total prime factors (sum of exponents)
                    const p1 = primes[Math.floor(Math.random() * 3)]; 
                    const p2 = primes[Math.floor(Math.random() * 3)];
                    const e1 = Math.floor(Math.random() * 3) + 2; // exponent 2 to 4
                    const e2 = Math.floor(Math.random() * 2) + 1; // exponent 1 to 2
                    const num = Math.pow(p1, e1) * Math.pow(p2, e2);
                    const totalFactors = e1 + e2;

                    questionText = `次の数を素因数分解したとき、素因数は全部で何個ありますか？（重複も含めて数える）<br>数：$${num}$`;
                    targetVal = totalFactors;
                    unit = "個";
                    explanation = `<strong>指数を足し合わせる</strong><br>
                    $${num} = ${p1}^${e1} \\times ${p2}^${e2}$ と分解できます。<br>
                    素因数の個数は指数の和なので、$${e1} + ${e2} = ${totalFactors}$ 個となります。<br>
                    (${p1}が${e1}個、${p2}が${e2}個)`;

                } else if (type < 0.75) {
                    // Type 3: Reverse Factorization (Equation to Number) - NEW
                    // Shows the "kind of multiplication" and asks for the number
                    const p1 = primes[Math.floor(Math.random() * 3)]; // Small primes
                    const p2 = primes[Math.floor(Math.random() * 3)];
                    const e1 = Math.floor(Math.random() * 2) + 2; // 2 or 3
                    const e2 = Math.random() > 0.5 ? 1 : 2; 
                    // Ensure distinct primes if exponent is 1 to look nice
                    // but logic handles p1=p2. Let's force distinct for clarity
                    const distinctP1 = p1;
                    let distinctP2 = p2;
                    while(distinctP2 === distinctP1) distinctP2 = primes[Math.floor(Math.random() * 3)];
                    
                    const val = Math.pow(distinctP1, e1) * Math.pow(distinctP2, e2);
                    const expr = `${distinctP1}^${e1} \\times ${distinctP2}^${e2 === 1 ? '' : e2}`; // Fix exponent 1 format

                    questionText = `次の素因数分解の式で表される整数を求めなさい：<br>$$ ${expr} $$`;
                    targetVal = val;
                    explanation = `<strong>素因数分解の式を計算して戻す</strong><br>
                    式を展開して計算します。<br>
                    $${distinctP1}^${e1} = ${Math.pow(distinctP1, e1)}$<br>
                    $${distinctP2}^${e2 === 1 ? '' : e2} = ${Math.pow(distinctP2, e2)}$<br>
                    したがって、$${Math.pow(distinctP1, e1)} \\times ${Math.pow(distinctP2, e2)} = ${val}$ となります。`;

                } else {
                    // Type 4: Sum of distinct prime factors
                    const distinctPrimes = [];
                    while(distinctPrimes.length < (Math.random() > 0.5 ? 2 : 3)) {
                        const p = primes[Math.floor(Math.random() * 5)]; // 2,3,5,7,11
                        if(!distinctPrimes.includes(p)) distinctPrimes.push(p);
                    }
                    let num = 1;
                    distinctPrimes.forEach(p => num *= p * (Math.random()>0.5 ? p : 1)); 
                    
                    const sumDistinct = distinctPrimes.reduce((a,b) => a+b, 0);

                    questionText = `次の数を素因数分解し、出てくる「異なる素因数」をすべて足すといくつになりますか？<br>数：$${num}$`;
                    targetVal = sumDistinct;
                    unit = "";
                    explanation = `<strong>種類の和を求める</strong><br>
                    $${num}$ を素因数分解すると $${getFactorizationString(num)}$ です。<br>
                    含まれる異なる素因数は $${distinctPrimes.sort((a,b)=>a-b).join(', ')}$ です。<br>
                    足し合わせると：$${distinctPrimes.join(' + ')} = ${sumDistinct}$`;
                }

                problems.push({
                    id: i + 1,
                    text: questionText,
                    val: targetVal,
                    explanation: explanation,
                    unit: unit
                });
            }
            
            return problems;
        }

        // Helper to get formatted string like 2^3 \times 3
        function getFactorizationString(n) {
            const factors = {};
            let d = 2;
            let temp = n;
            while (d * d <= temp) {
                while (temp % d === 0) {
                    factors[d] = (factors[d] || 0) + 1;
                    temp /= d;
                }
                d++;
            }
            if (temp > 1) {
                factors[temp] = (factors[temp] || 0) + 1;
            }
            
            let parts = [];
            for (let p in factors) {
                if (factors[p] === 1) parts.push(p);
                else parts.push(`${p}^${factors[p]}`);
            }
            return parts.join(' \\times ');
        }

        // --- 3. Rendering Quiz HTML ---
        function generateQuizHTML() {
            currentQuestions = generateFactorization();
            const container = document.getElementById('quizContainer');
            container.innerHTML = ''; // Clear

            currentQuestions.forEach(q => {
                const card = document.createElement('div');
                card.className = "bg-white p-8 rounded-3xl border border-slate-200 shadow-sm transition-all hover:shadow-md dark:bg-slate-800 dark:border-slate-700 relative overflow-hidden";
                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-2 h-full bg-indigo-500"></div>
                    <div class="flex items-center gap-3 mb-5">
                        <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200 font-bold px-4 py-1.5 rounded-full text-sm tracking-wide">Q.${q.id}</span>
                        ${q.unit ? `<span class="text-xs font-bold text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">応用問題</span>` : ''}
                    </div>
                    <div class="text-slate-800 dark:text-slate-200 mb-8 text-lg leading-relaxed font-medium serif-text">
                        ${q.text}
                    </div>
                    <div class="flex gap-4 items-center mb-6">
                        <input type="number" id="q${q.id}-input" class="quiz-input w-full p-4 border-2 border-slate-200 rounded-2xl font-bold text-xl text-slate-700 placeholder-slate-300 dark:bg-slate-900 dark:border-slate-600 dark:text-slate-100" placeholder="答えを入力" step="1">
                        <span class="font-bold text-slate-400 text-xl whitespace-nowrap">${q.unit}</span>
                    </div>
                    <button onclick="checkAnswer(${q.id})" class="group w-full bg-slate-800 text-white font-bold py-4 rounded-2xl hover:bg-slate-700 transition-all shadow-lg shadow-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 dark:shadow-none flex items-center justify-center gap-2">
                        <span>答え合わせ</span>
                        <!-- Bootstrap Icon: arrow-right-circle -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="opacity-50 group-hover:opacity-100 transition-opacity" viewBox="0 0 16 16">
                           <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
                        </svg>
                    </button>
                    
                    <div id="q${q.id}-feedback" class="feedback-box bg-slate-100 dark:bg-slate-900/50"></div>
                `;
                container.appendChild(card);
            });

            // Re-render MathJax/KaTeX for the new content
            renderMath();
        }

        // --- 4. Validation Logic ---
        function checkAnswer(qId) {
            // qId is 1-based index
            const data = currentQuestions[qId - 1];
            const input = document.getElementById(`q${qId}-input`);
            const feedback = document.getElementById(`q${qId}-feedback`);
            const userVal = parseInt(input.value); // Integers for factorization

            feedback.style.display = 'block';
            input.classList.remove('correct-answer', 'incorrect-answer');

            // Exact match for factorization problems (integers)
            if (userVal === data.val) {
                // Correct
                input.classList.add('correct-answer');
                feedback.innerHTML = `
                    <div class="text-green-700 dark:text-green-400 font-bold text-lg mb-3 flex items-center gap-2">
                        <!-- Bootstrap Icon: check-circle-fill -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                        </svg>
                        正解です！
                    </div>
                    <div class="mt-3 bg-white dark:bg-slate-800 p-5 rounded-2xl border border-green-200 dark:border-green-800 text-slate-700 dark:text-slate-300 shadow-sm leading-relaxed">
                        <strong class="text-green-800 dark:text-green-300 block mb-2 text-sm uppercase tracking-wider">Solution</strong>
                        ${data.explanation}
                    </div>
                `;
                feedback.className = "feedback-box bg-green-50 border border-green-200 dark:bg-green-900/20 dark:border-green-800";
            } else {
                // Incorrect
                input.classList.add('incorrect-answer');
                feedback.innerHTML = `
                    <div class="text-red-700 dark:text-red-400 font-bold text-lg mb-3 flex items-center gap-2">
                        <!-- Bootstrap Icon: x-circle-fill -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                        </svg>
                        不正解です...
                    </div>
                    <p class="text-slate-600 dark:text-slate-400 mb-4 text-sm">計算ミスがあるようです。もう一度分解を確認してみましょう。</p>
                    <div class="pt-4 border-t border-red-200 dark:border-red-800">
                        <button onclick="document.getElementById('reveal-${qId}').classList.remove('hidden')" class="text-red-600 dark:text-red-400 font-bold text-sm hover:text-red-800 dark:hover:text-red-300 underline decoration-2 underline-offset-4">
                            答えと解説を見る
                        </button>
                        <div id="reveal-${qId}" class="hidden mt-4 bg-white dark:bg-slate-800 p-5 rounded-2xl border border-red-200 dark:border-red-800 text-slate-700 dark:text-slate-300 shadow-sm leading-relaxed">
                             <div class="mb-3 text-lg font-bold text-red-700 dark:text-red-400 border-b border-red-100 dark:border-red-900 pb-2">正解：${data.val} ${data.unit}</div>
                             <div class="text-sm">${data.explanation}</div>
                        </div>
                    </div>
                `;
                feedback.className = "feedback-box bg-red-50 border border-red-200 dark:bg-red-900/20 dark:border-red-800";
            }
            renderMath(); // Re-render math in feedback
        }

        // --- 5. Event Listeners ---
        const quizTrigger = document.getElementById('quizTrigger');
        const quizPanel = document.getElementById('quizPanel');
        const closeQuiz = document.getElementById('closeQuiz');
        const generateBtn = document.getElementById('generateBtn');

        quizTrigger.addEventListener('click', () => {
            quizPanel.classList.add('active');
            if (currentQuestions.length === 0) {
                // Initial prompt is shown, user clicks generate
            }
        });

        closeQuiz.addEventListener('click', () => {
            quizPanel.classList.remove('active');
        });

        generateBtn.addEventListener('click', () => {
            generateQuizHTML();
            const container = document.getElementById('quizContainer');
            if (container) container.scrollTop = 0;
        });

        // Initialize KaTeX on load
        document.addEventListener("DOMContentLoaded", function() {
            renderMath();
        });
    </script>
</body>
</html>
  